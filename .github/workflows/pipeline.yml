name: Build → Push → Deploy (+Notify)

on:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  build:
    uses: ./.github/workflows/build.yml
    with:
      image_name: ghcr.io/miroslavnecas/website
    secrets: inherit

  push:
    needs: build
    uses: ./.github/workflows/push.yml
    with:
      image_name: ghcr.io/miroslavnecas/website
    secrets: inherit

  notify_predeploy:
    needs: [build, push]
    uses: ./.github/workflows/notify_predeploy.yml
    with:
      sha: ${{ needs.build.outputs.sha }}
    secrets:
      N8N_URL: ${{ secrets.N8N_WEBHOOK_URL }}

  deploy:
    needs: push
    uses: ./.github/workflows/deploy.yml
    with:
      stack_dir: /root/website
    secrets:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY: ${{ secrets.SSH_KEY }}

  notify_final:
    if: always()
    needs: [build, push, deploy]
    uses: ./.github/workflows/notify_final.yml
    with:
      sha: ${{ needs.build.outputs.sha }}
      build_result:  ${{ needs.build.result }}
      push_result:   ${{ needs.push.result }}
      deploy_result: ${{ needs.deploy.result }}
    secrets:
      N8N_URL: ${{ secrets.N8N_WEBHOOK_URL }}